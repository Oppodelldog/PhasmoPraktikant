<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title data-text-id="html_title">Phasmophobia Deduction Helper</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            outline: none;
            font-size: 18px;
            box-sizing: border-box;
        }

        a, a:visited {
            color: white;
            font-weight: bold;
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        h1 {
            font-size: 26px;
            line-height: 34px;
            text-align: center;
        }

        body {
            color: white;
            background-color: black;
            margin-left: 20px;
            margin-right: 20px;
        }

        h1 {
            cursor: pointer;
        }

        .content {
            margin-top: 20px;

            display: flex;
            flex-direction: column;
            justify-items: center;
            align-items: center;
        }


        .content > * + * {
            margin-top: 30px;
        }

        .ghost {
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            align-items: center;

            padding-left: 10px;
            padding-right: 10px;
        }

        .ghost + .ghost {
            margin-top: 8px;
        }

        .ghost > * + * {
            margin-left: 10px;
        }

        .ghost-name {
            font-weight: bold;
            width: 100px;
        }

        .ghost-evidence {
            font-size: 12px;
        }

        .option-headline {
            font-weight: bold;
        }

        .evidence-proven {
            color: greenyellow;
        }

        .evidence-excluded {
            color: #5d5d5d;
        }

        .ghost-excluded, .ghost-excluded > * {
            text-decoration: line-through;
            color: #5d5d5d;
        }

        .ghost-excluded .ghost-evidence.evidence-proven {
            color: #7b946d;
        }

        .ghost-convicted {
            color: #fff;
            text-shadow: 0 0 30px #487325, 0 0 40px #59b343, 0 0 50px #a4ff58, 0 0 60px #94ff68, 0 0 70px #b4ffa6, 0 0 80px #dbffc8;
        }

        .label {
            width: 120px;
        }

        .option {
            margin-left: 30px;
        }

        .evidence {
            display: grid;
            grid-template-rows: 33.3333% 33.3333% 33.3333%;
            grid-template-columns: 33.3333% 33.3333% 33.3333%;
            row-gap: 40px;
        }

        .evidence-button {
            margin-left: 30px;
            margin-right: 30px;
            position: relative;
            display: block;
            width: 64px;
            height: 64px;
            background-size: contain;
        }

        .evidence-button-yes, .evidence-button-no {
            position: absolute;
            background-size: contain;
            width: 32px;
            height: 32px;
            bottom: -12px;
        }

        .evidence-button-no {
            background-image: url(assets/no_off.png);
            left: -13px;
        }

        .evidence-button-yes {
            background-image: url(assets/yes_off.png);
            right: -13px;
        }

        .evidence-button-no.evidence-button-selected {
            background-image: url(assets/no_on.png);
        }

        .evidence-button-yes.evidence-button-selected {
            background-image: url(assets/yes_on.png);
        }

        .evidence-button.id-1.impossible {
            background-image: url(assets/box_impossible.png);
        }

        .evidence-button.id-1.possible {
            background-image: url(assets/box_possible.png);
        }

        .evidence-button.id-1.proven {
            background-image: url(assets/box_proven.png);
        }

        .evidence-button.id-2.impossible {
            background-image: url(assets/uv_impossible.png);
        }

        .evidence-button.id-2.possible {
            background-image: url(assets/uv_possible.png);
        }

        .evidence-button.id-2.proven {
            background-image: url(assets/uv_proven.png);
        }

        .evidence-button.id-3.impossible {
            background-image: url(assets/book_impossible.png);
        }

        .evidence-button.id-3.possible {
            background-image: url(assets/book_possible.png);
        }

        .evidence-button.id-3.proven {
            background-image: url(assets/book_proven.png);
        }

        .evidence-button.id-4.impossible {
            background-image: url(assets/temp_impossible.png);
        }

        .evidence-button.id-4.possible {
            background-image: url(assets/temp_possible.png);
        }

        .evidence-button.id-4.proven {
            background-image: url(assets/temp_proven.png);
        }

        .evidence-button.id-5.impossible {
            background-image: url(assets/emf_impossible.png);
        }

        .evidence-button.id-5.possible {
            background-image: url(assets/emf_possible.png);
        }

        .evidence-button.id-5.proven {
            background-image: url(assets/emf_proven.png);
        }

        .evidence-button.id-6.impossible {
            background-image: url(assets/orb_impossible.png);
        }

        .evidence-button.id-6.possible {
            background-image: url(assets/orb_possible.png);
        }

        .evidence-button.id-6.proven {
            background-image: url(assets/orb_proven.png);
        }
    </style>
</head>
<body>
<div class="content">
    <h1 id="headline" data-text-id="html_headline">Phasmophobia Deduction Helper</h1>
    <div id="controls" class="controls">
        <div id="evidence" class="evidence">
        </div>
    </div>
    <div id="overview" class="overview"></div>
    <div class="languages"><a href="?locale=en">EN</a> - <a href="?locale=fr">FR</a> - <a href="?locale=de">DE</a></div>
</div>

<script type="application/ecmascript">
    const text = {
        "de": {
            "html_title": "Phasmo-Praktikant",
            "html_headline": "Phasmo-Praktikant",

            "evidence_box": "Box",
            "evidence_fingerprints": "Fingerabd.",
            "evidence_book": "Buch",
            "evidence_freezing": "Gefriertemp.",
            "evidence_emf5": "EMF - 5",
            "evidence_orb": "Orb",

            "evidence_proven": "Hab Isch gehabt Alter",
            "evidence_excluded": "Dat sacht mir jetzt nix",

            "ghost_spirit": "Spirit",
            "ghost_wraith": "Gespenst",
            "ghost_phantom": "Phantom",
            "ghost_poltergeist": "Poltergeist",
            "ghost_banshee": "Banshee",
            "ghost_jinn": "Dshinn",
            "ghost_mare": "Mare",
            "ghost_revenant": "Revenant",
            "ghost_shade": "Shade",
            "ghost_demon": "Dämon",
            "ghost_yurei": "Yurei",
            "ghost_oni": "Oni",
        },
        "en": {
            "html_title": "Phasmophobia Deduction Helper",
            "html_headline": "Phasmophobia Deduction&nbsp;Helper",

            "evidence_box": "Box",
            "evidence_fingerprints": "Fingerprints",
            "evidence_book": "Writing",
            "evidence_freezing": "Freezing",
            "evidence_emf5": "EMF - 5",
            "evidence_orb": "Orb",

            "evidence_proven": "Yes, I had that",
            "evidence_excluded": "Nope, not faced this evidence.",

            "ghost_spirit": "Spirit",
            "ghost_wraith": "Wraith",
            "ghost_phantom": "Phantom",
            "ghost_poltergeist": "Poltergeist",
            "ghost_banshee": "Banshee",
            "ghost_jinn": "Jinn",
            "ghost_mare": "Mare",
            "ghost_revenant": "Revenant",
            "ghost_shade": "Shade",
            "ghost_demon": "Demon",
            "ghost_yurei": "Yurei",
            "ghost_oni": "Oni",
        },
        "fr": {
            "html_title": "Phasmophobia Assistante Déduction",
            "html_headline": "Phasmophobia Assistante&nbsp;Déduction",

            "evidence_box": "Box",
            "evidence_fingerprints": "Empreintes",
            "evidence_book": "Ecriture",
            "evidence_freezing": "Glaciales",
            "evidence_emf5": "EMF - 5",
            "evidence_orb": "Orbe",

            "evidence_proven": "Oui, j'avais ça",
            "evidence_excluded": "Non, pas face à cette preuve.",

            "ghost_spirit": "Esprit",
            "ghost_wraith": "Spectre",
            "ghost_phantom": "Fantôme",
            "ghost_poltergeist": "Poltergeist",
            "ghost_banshee": "Banshee",
            "ghost_jinn": "Jinn",
            "ghost_mare": "Cauchemar",
            "ghost_revenant": "Revenant",
            "ghost_shade": "Ombre",
            "ghost_demon": "Démon",
            "ghost_yurei": "Yurei",
            "ghost_oni": "Oni",
        }
    }

    let dictionary = null;

    const evidence = {
        "1": "evidence_box",
        "2": "evidence_fingerprints",
        "3": "evidence_book",
        "4": "evidence_freezing",
        "5": "evidence_emf5",
        "6": "evidence_orb",
    }

    const ghosts = [
        { name: "ghost_spirit", evidence: ["1", "2", "3"] },
        { name: "ghost_wraith", evidence: ["2", "4", "1"] },
        { name: "ghost_phantom", evidence: ["5", "6", "4"] },
        { name: "ghost_poltergeist", evidence: ["1", "2", "6"] },
        { name: "ghost_banshee", evidence: ["5", "2", "4"] },
        { name: "ghost_jinn", evidence: ["1", "6", "5"] },
        { name: "ghost_mare", evidence: ["1", "6", "4"] },
        { name: "ghost_revenant", evidence: ["5", "2", "3"] },
        { name: "ghost_shade", evidence: ["5", "6", "3"] },
        { name: "ghost_demon", evidence: ["1", "3", "4"] },
        { name: "ghost_yurei", evidence: ["6", "3", "4"] },
        { name: "ghost_oni", evidence: ["5", "1", "3"] },
    ]

    const evidenceStatus = {
        "1": 0,
        "2": 0,
        "3": 0,
        "4": 0,
        "5": 0,
        "6": 0,
    }

    const scoreExcluded = -1
    const scoreSuspicious = 0
    const scoreConvicted = 1

    const evidenceExcluded = -1
    const evidenceUnchecked = 0
    const evidenceProven = 1

    function updateButtons() {
        const selectedClass = "evidence-button-selected"

        for (let id of Object.keys(evidenceStatus)) {
            if (!evidenceStatus.hasOwnProperty(id)) {
                continue
            }

            const yes = document.getElementById(buttonIdYes(id))
            const no = document.getElementById(buttonIdNo(id))

            yes.classList.remove(selectedClass)
            no.classList.remove(selectedClass)

            switch (evidenceStatus[id]) {
                case evidenceExcluded:
                    no.classList.add(selectedClass)
                    break
                case evidenceUnchecked:
                    break
                case evidenceProven:
                    yes.classList.add(selectedClass)
                    break
            }

            const bt = document.getElementById(buttonId(id))
            const impossibleClass = "impossible"
            const possibleClass = "possible"
            const provenClass = "proven"

            let isManuallyExcluded = evidenceStatus[id] === evidenceExcluded;
            let isManuallyProven = evidenceStatus[id] === evidenceProven;
            let isPossible = getPossibleEvidences().indexOf(id) > -1;

            bt.classList.remove(impossibleClass, possibleClass, provenClass)

            if (isManuallyExcluded) {
                bt.classList.add(impossibleClass)
            } else if (isManuallyProven) {
                bt.classList.add(provenClass)
            } else if (isPossible) {
                bt.classList.add(possibleClass)
            } else if (!isPossible) {
                bt.classList.add(impossibleClass)
            }
        }
    }

    function updateSelection(e, id, val) {
        e.stopPropagation()

        if (evidenceStatus[id] === val) {
            evidenceStatus[id] = evidenceUnchecked
        } else {
            evidenceStatus[id] = val
        }

        updateButtons()
        renderOverview()
    }

    function getEvidences(e) {
        return e.evidence.map((evId) => {
            const name = getText(evidence[evId])
            const ev = document.createElement("div")

            const status = parseInt(evidenceStatus[evId])
            let statusClass = status === evidenceExcluded ? "evidence-excluded" : status === evidenceProven ? "evidence-proven" : "tbd"

            ev.classList.add("ghost-evidence")
            ev.classList.add(statusClass)
            ev.innerHTML = name

            return ev
        })
    }

    function buttonIdYes(id) {
        return "evidence-button-yes-" + id
    }

    function buttonIdNo(id) {
        return "evidence-button-no-" + id
    }

    function buttonId(id) {
        return "evidence-button-" + id
    }

    function createEvidenceButton(name, id) {
        const button = document.createElement("div")
        const yes = document.createElement("div")
        const no = document.createElement("div")
        const classId = "id-" + id

        button.id = buttonId(id)
        yes.id = buttonIdYes(id)
        no.id = buttonIdNo(id)

        button.title = name
        yes.title = getText("evidence_proven")
        no.title = getText("evidence_excluded")

        button.classList.add("evidence-button")
        yes.classList.add("evidence-button-yes")
        no.classList.add("evidence-button-no")

        button.classList.add(classId)
        yes.classList.add(classId)
        no.classList.add(classId)

        button.addEventListener("click", (e) => updateSelection(e, id, evidenceUnchecked))
        yes.addEventListener("click", (e) => updateSelection(e, id, evidenceProven))
        no.addEventListener("click", (e) => updateSelection(e, id, evidenceExcluded))

        button.appendChild(yes)
        button.appendChild(no)

        return button
    }

    function getProofs(evidence, sel) {
        return evidence.filter((ev) => parseInt(sel[ev]) > evidenceUnchecked).length
    }

    function getExcludes(evidence, sel) {
        return evidence.filter((ev) => parseInt(sel[ev]) < evidenceUnchecked).length
    }

    function getScore(evidence, proofs) {
        const maxNumberEvidence = 3;
        const scoredProofs = getProofs(evidence, evidenceStatus)
        const matchedExcluded = getExcludes(evidence, evidenceStatus)

        if (matchedExcluded > 0 || scoredProofs < proofs) {
            return scoreExcluded
        }

        if (scoredProofs === maxNumberEvidence) {
            return scoreConvicted
        }

        return scoreSuspicious
    }

    function getScoreClass(evidence, proofs) {
        const score = getScore(evidence, proofs)
        let scoreClass = "tbd"

        if (score === scoreExcluded) {
            return "ghost-excluded"
        } else if (score === scoreConvicted) {
            return "ghost-convicted"
        }

        return scoreClass
    }

    function getAllProofs() {
        return Object.keys(evidenceStatus).filter((e) => parseInt(evidenceStatus[e]) === 1).length
    }

    function renderOverview() {
        const proofs = getAllProofs()
        const overview = document.getElementById("overview")
        while (overview.firstChild) {
            overview.firstChild.remove()
        }

        ghosts.map((g) => {
            const ghost = document.createElement("div")
            const name = document.createElement("div")
            const scoreClass = getScoreClass(g.evidence, proofs)

            ghost.classList.add(scoreClass)
            ghost.classList.add("ghost")
            name.classList.add("ghost-name")
            name.innerHTML = getText(g.name)

            ghost.appendChild(name)

            getEvidences(g).map((ev) => ghost.appendChild(ev))

            overview.appendChild(ghost)
        })
    }

    function getPossibleEvidences() {
        let possibleEvidences = ghosts
            .map((g) => g.evidence)
            .filter((evidence) => getScore(evidence, getAllProofs()) >= scoreSuspicious)

        if (possibleEvidences.length === 0) {
            return []
        }

        return possibleEvidences
            .reduce((p, c) => p.concat(c))
            .filter((value, index, self) => self.indexOf(value) === index)
    }

    function renderControls() {
        const ev = document.getElementById("evidence")
        for (let k of Object.keys(evidence)) {
            let evidenceName = getText(evidence[k]);
            ev.appendChild(createEvidenceButton(evidenceName, k))
        }
    }

    function getText(id) {
        let translation = dictionary[id];
        if (translation === undefined) {
            console.warn(`translation not found for '${id}'`)
        }
        return translation
    }

    function setDictionary(acceptedLocales) {
        for (let browserLocale of acceptedLocales) {
            for (let locale of Object.keys(text)) {
                if (!text.hasOwnProperty(locale)) {
                    continue
                }

                if (locale === browserLocale) {
                    dictionary = text[locale]

                    return
                }
            }
        }

        if (dictionary === null) {
            dictionary = text["en"];
            console.warn(`cannot find text for any of ${navigator.languages}. falling back to default locale`)
        }
    }

    function translateHtmlElements() {
        for (let textId of Object.keys(dictionary)) {
            let element = document.querySelector(`[data-text-id="${textId}"]`);
            if (element === null) {
                return
            }

            element.innerHTML = dictionary[textId]
        }
    }

    function applyText() {
        let acceptedLocales = navigator.languages;
        const preferredLocale = new URLSearchParams(window.location.search).get('locale')
        if (preferredLocale !== "") {
            acceptedLocales = [preferredLocale].concat(acceptedLocales)
        }

        setDictionary(acceptedLocales);
        translateHtmlElements();
    }

    window.onload = () => {
        applyText()
        document.getElementById("headline").addEventListener("click", () => location.reload())
        renderControls()
        updateButtons()
        renderOverview()
    }
</script>
</body>
</html>
